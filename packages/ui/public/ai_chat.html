<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            html,
            body {
                margin: 0;
                padding: 0;
            }
        </style>
    </head>

    <body>
        <flowise-fullchatbot id="flowiseFullchatbot"></flowise-fullchatbot>
        <script>
            window.addEventListener('message', receiveMessage, false)
            const matchOrigin = new RegExp(`experimental.cloudladder.net.cn$`)

            let initChatOptions = {
                theme: {
                    chatWindow: {
                        showTitle: true,
                        title: '尚云数智Bot',
                        titleAvatarSrc: './messages.svg',
                        welcomeMessage: '你好呀!',
                        backgroundColor: '#ffffff',
                        fontSize: 16,
                        poweredByTextColor: '#303235',
                        botMessage: {
                            backgroundColor: '#f7f8ff',
                            textColor: '#303235',
                            showAvatar: true,
                            avatarSrc: './parroticon.png'
                        },
                        userMessage: {
                            backgroundColor: '#3B81F6',
                            textColor: '#ffffff',
                            showAvatar: true,
                            avatarSrc: './usericon.png'
                        },
                        textInput: {
                            placeholder: '请输入',
                            backgroundColor: '#ffffff',
                            textColor: '#303235',
                            sendButtonColor: '#3B81F6'
                        }
                    }
                }
            }

            function deepAssign(target, source) {
                for (let key in source) {
                    if (source[key] != null && typeof source[key] === 'object') {
                        if (
                            !target.hasOwnProperty(key) ||
                            typeof target[key] !== 'object' ||
                            Array.isArray(target[key]) !== Array.isArray(source[key])
                        ) {
                            target[key] = Array.isArray(source[key]) ? [] : {}
                        }
                        deepAssign(target[key], source[key])
                    } else {
                        target[key] = source[key]
                    }
                }
                return target
            }

            function setPropertyByPath(obj, path, value) {
                const keys = path.split('.')
                let current = obj

                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current.hasOwnProperty(keys[i]) || typeof current[keys[i]] !== 'object') {
                        current[keys[i]] = {}
                    }
                    current = current[keys[i]]
                }

                current[keys[keys.length - 1]] = value

                return obj
            }

            function receiveMessage(event) {
                const origin = event.origin

                if (!matchOrigin.test(origin)) return
                const data = event.data

                deepAssign(initChatOptions, event.data)

                window.removeEventListener('message', receiveMessage, false)
            }

            const queryData = new URLSearchParams(window.location.search)

            queryData.forEach((value, key) => {
                setPropertyByPath(initChatOptions, key, value)
            })
        </script>
        <script type="module">
            import Chatbot from './chat-js/web.js'

            setTimeout(() => {
                Chatbot.initFull(initChatOptions)
                initChatOptions = void 0
                window.removeEventListener('message', receiveMessage, false)
            })
        </script>
    </body>
</html>
