<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            html,
            body {
                margin: 0;
                padding: 0;
            }
            .loading,
            .loading > div {
                position: relative;
                box-sizing: border-box;
            }

            .loading {
                display: block;
                font-size: 0;
                color: #1677ff;
            }

            .loading.la-dark {
                color: #333;
            }

            .loading > div {
                display: inline-block;
                float: none;
                background-color: currentColor;
                border: 0 solid currentColor;
            }

            /* .loading {
                width: 45px;
                height: 36px;
            } */

            .loading > div {
                width: 6px;
                height: 72px;
                margin: 6px;
                border-radius: 3px;
                margin-top: 0;
                margin-bottom: 0;
                animation-name: line-scale-party;
                animation-iteration-count: infinite;
            }

            .loading > div:nth-child(1) {
                animation-duration: 0.43s;
                animation-delay: -0.23s;
            }

            .loading > div:nth-child(2) {
                animation-duration: 0.62s;
                animation-delay: -0.32s;
            }

            .loading > div:nth-child(3) {
                animation-duration: 0.43s;
                animation-delay: -0.44s;
            }

            .loading > div:nth-child(4) {
                animation-duration: 0.8s;
                animation-delay: -0.31s;
            }

            .loading > div:nth-child(5) {
                animation-duration: 0.74s;
                animation-delay: -0.24s;
            }

            .loading.la-sm {
                width: 20px;
                height: 16px;
            }

            .loading.la-sm > div {
                width: 2px;
                height: 16px;
                margin: 1px;
                margin-top: 0;
                margin-bottom: 0;
            }

            .loading.la-2x {
                width: 80px;
                height: 64px;
            }

            .loading.la-2x > div {
                width: 8px;
                height: 64px;
                margin: 4px;
                margin-top: 0;
                margin-bottom: 0;
            }

            .loading.la-3x {
                width: 120px;
                height: 96px;
            }

            .loading.la-3x > div {
                width: 12px;
                height: 96px;
                margin: 6px;
                margin-top: 0;
                margin-bottom: 0;
            }

            @keyframes line-scale-party {
                0% {
                    transform: scaleY(1);
                }

                50% {
                    transform: scaleY(0.3);
                }

                100% {
                    transform: scaleY(1);
                }
            }
            #chat-spin {
                width: 100vw;
                height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #chat-spin > div {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 9px;
                flex-direction: column;
                font-size: 15px;
                color: rgba(22, 119, 255, 0.81);
            }
        </style>
    </head>

    <body>
        <div id="chat-spin">
            <div class="center">
                <div class="loading">
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
                加载中 ...
            </div>
        </div>
        <script>
            window.addEventListener('message', receiveMessage, false)
            const matchOrigin = new RegExp(`experimental.cloudladder.net.cn$`)

            let initChatOptions = {
                theme: {
                    chatWindow: {
                        showTitle: true,
                        title: '尚云数智Bot',
                        titleAvatarSrc: './messages.svg',
                        welcomeMessage: '你好呀!',
                        backgroundColor: '#ffffff',
                        fontSize: 16,
                        poweredByTextColor: '#303235',
                        botMessage: {
                            backgroundColor: '#f7f8ff',
                            textColor: '#303235',
                            showAvatar: true,
                            avatarSrc: './parroticon.png'
                        },
                        userMessage: {
                            backgroundColor: '#3B81F6',
                            textColor: '#ffffff',
                            showAvatar: true,
                            avatarSrc: './usericon.png'
                        },
                        textInput: {
                            placeholder: '请输入',
                            backgroundColor: '#ffffff',
                            textColor: '#303235',
                            sendButtonColor: '#3B81F6'
                        }
                    }
                }
            }

            function deepAssign(target, source) {
                for (let key in source) {
                    if (source[key] != null && typeof source[key] === 'object') {
                        if (
                            !target.hasOwnProperty(key) ||
                            typeof target[key] !== 'object' ||
                            Array.isArray(target[key]) !== Array.isArray(source[key])
                        ) {
                            target[key] = Array.isArray(source[key]) ? [] : {}
                        }
                        deepAssign(target[key], source[key])
                    } else {
                        if (
                            ['[object Undefined]', '[object Null]'].includes(Object.prototype.toString.call(source[key])) ||
                            (typeof source[key] == 'string' && !source[key].trim())
                        ) {
                        } else target[key] = source[key]
                    }
                }
                return target
            }

            function setPropertyByPath(obj, path, value) {
                const keys = path.split('.')
                let current = obj

                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current.hasOwnProperty(keys[i]) || typeof current[keys[i]] !== 'object') {
                        current[keys[i]] = {}
                    }
                    current = current[keys[i]]
                }

                try {
                    if (typeof current[keys[keys.length - 1]] !== 'string') value = JSON.parse(value)
                } catch (error) {}

                current[keys[keys.length - 1]] = value

                return obj
            }

            function receiveMessage(event) {
                const origin = event.origin

                if (!matchOrigin.test(origin)) return

                deepAssign(initChatOptions, event.data)

                window.removeEventListener('message', receiveMessage, false)
            }

            let queryData = new URLSearchParams(window.location.search)

            queryData.forEach((value, key) => {
                setPropertyByPath(initChatOptions, key, value)
            })
        </script>
        <script type="module">
            import Chatbot from './chat-js/web.js'

            function init() {
                const element = document.createElement('flowise-fullchatbot')

                document.body.replaceChild(element, document.body.firstElementChild)

                Chatbot.initFull(initChatOptions)
                queryData = initChatOptions = void 0
                window.removeEventListener('message', receiveMessage, false)
            }

            if (typeof window.parent.postMessage === 'function') {
                window.parent.postMessage({ uniqueKey: queryData.get('key') }, '*')

                setTimeout(init, 150)
            } else init()
        </script>
    </body>
</html>
